<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project-4869: 名侦探柯南资源管理</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <script src="https://unpkg.com/@element-plus/icons-vue"></script>

    <style>
        /* --- CSS 变量定义主题 --- */
        :root {
            /* 亮色模式默认值 */
            --bg-image: url('/static/bg-light.jpg');
            --bg-position: left center;
            --bg-overlay: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.2) 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.6);
            
            --text-primary: #1f2937;   /* gray-800 */
            --text-secondary: #6b7280; /* gray-500 */
            --text-blue: #1e40af;      /* blue-800 */
            
            --card-bg: #ffffff;
            --card-border: #f3f4f6;    /* gray-100 */
            --header-bg: rgba(255, 255, 255, 0.9);
            
            --tag-info-bg: #f4f4f5;
            --tag-info-text: #909399;
        }

        /* 暗色模式重写 */
        html[data-theme="dark"] {
            --bg-image: url('/static/bg-dark.jpg');
            --bg-position: right center;
            /* 暗色模式叠加一层深色渐变，让文字更清晰 */
            --bg-overlay: linear-gradient(135deg, rgba(17, 24, 39, 0.7) 0%, rgba(17, 24, 39, 0.5) 100%);
            /* 深色毛玻璃 */
            --glass-bg: rgba(17, 24, 39, 0.25);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --text-primary: #f9fafb;   /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --text-blue: #60a5fa;      /* blue-400 */
            
            --card-bg: #1f2937;        /* gray-800 */
            --card-border: #374151;    /* gray-700 */
            --header-bg: rgba(17, 24, 39, 0.9);

            --tag-info-bg: #374151;
            --tag-info-text: #d1d5db;
        }

        body {
            margin: 0;
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: var(--glass-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-wallpaper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--bg-overlay), var(--bg-image);
            background-size: cover;
            background-position: var(--bg-position);
            z-index: -1;
            transition: background-image 0.3s, background-position 0.3s;
        }
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            min-height: 100vh;
            border-right: 1px solid var(--glass-border);
            border-left: 1px solid var(--glass-border);
        }
        /* 头部导航 */
        .top-nav {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--glass-border);
        }
        /* 统计卡片 */
        .stats-card {
            background-color: var(--header-bg);
            border: 1px solid var(--glass-border);
        }
        
        /* 移除输入框边框，用于融合控件 */
        .no-border-input .el-input__wrapper {
            box-shadow: none !important;
            background-color: transparent !important;
            padding-left: 0;
        }
        /* 资源卡片 */
        .resource-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
        }
        .resource-card-header {
            background-color: var(--card-border); /* 稍微深一点的头部背景 */
            border-bottom: 1px solid var(--card-border);
        }
        .resource-row {
            transition: all 0.2s;
            border-color: var(--card-border);
        }
        .resource-row:hover {
            /* 暗色模式下的悬停高亮需要特殊处理 */
            background-color: rgba(59, 130, 246, 0.1); /* blue-500 with opacity */
        }
        /* 分页器样式优化 */
        .el-pagination {
            justify-content: center;
            margin-top: 2rem;
            padding: 1rem;
            background: var(--header-bg);
            border-radius: 1rem;
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        /* 暗色模式下 Element Plus 的一些微调 */
        html[data-theme="dark"] .el-tag--info {
            --el-tag-bg-color: var(--tag-info-bg);
            --el-tag-border-color: var(--card-border);
            --el-tag-text-color: var(--tag-info-text);
        }
        html[data-theme="dark"] .el-radio-button__inner {
            background: var(--card-bg);
            color: var(--text-secondary);
            border-color: var(--card-border);
        }
        html[data-theme="dark"] .el-radio-button:first-child .el-radio-button__inner {
            border-left-color: var(--card-border);
        }
        html[data-theme="dark"] .el-drawer {
            background: var(--card-bg) !important;
        }
        html[data-theme="dark"] .el-drawer__title {
            color: var(--text-primary) !important;
        }
        .priority-popover {
            background: rgba(243, 244, 246, 0.98) !important;
            border: 1px solid var(--glass-border) !important;
            padding: 8px !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12) !important;
            backdrop-filter: blur(10px) !important;
        }
        html[data-theme="dark"] .priority-popover {
            background: rgba(15, 23, 42, 0.92) !important;
        }
        /* 修复 Cron 开关文字颜色适配 */
        .rss-switch .el-switch__inner .is-text {
            color: var(--text-primary);
        }
        .rss-switch.is-checked .el-switch__inner .is-text {
            color: #fff;
        }
    </style>
</head>
<body>
    <div id="app" class="h-screen flex overflow-hidden">
        <div class="bg-wallpaper"></div>
        
        <!-- Mobile Sidebar Backdrop -->
        <div v-if="isSidebarOpen" 
             class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm lg:hidden transition-opacity" 
             @click="isSidebarOpen = false">
        </div>

        <aside class="fixed inset-y-0 left-0 z-50 w-72 flex flex-col border-r glass-panel transition-transform duration-300 lg:static lg:translate-x-0" 
               :class="isSidebarOpen ? 'translate-x-0' : '-translate-x-full'"
               style="background-color: var(--glass-bg); border-color: var(--glass-border); backdrop-filter: blur(20px);"> 
            
            <div class="h-16 flex items-center justify-between px-6 border-b transition-colors duration-300" style="border-color: var(--glass-border);"> 
                <h1 class="text-xl font-bold flex items-center gap-2" style="color: var(--text-blue)"> 
                    <el-icon><Monitor /></el-icon> Project-4869 
                </h1> 
                <el-button class="lg:hidden" link @click="isSidebarOpen = false">
                    <el-icon class="text-xl"><Close /></el-icon>
                </el-button>
            </div> 

            <div class="p-5 flex-1 overflow-y-auto space-y-5"> 
                
                <div class="rounded-xl border p-4 space-y-3 bg-gray-50/50 dark:bg-gray-800/30" style="border-color: var(--glass-border);">
                    <h3 class="text-xs font-medium opacity-60" style="color: var(--text-secondary)">Emby 连接</h3> 
                    
                    <div class="rounded-lg border px-2 py-1 bg-white/60 dark:bg-gray-900/40" style="border-color: var(--glass-border);">
                        <el-input v-model="embyConfig.host" placeholder="http://ip:8096" size="default" class="no-border-input"> 
                            <template #prefix><el-icon><Link /></el-icon></template> 
                        </el-input> 
                    </div>
                    <div class="rounded-lg border px-2 py-1 bg-white/60 dark:bg-gray-900/40" style="border-color: var(--glass-border);">
                        <el-input v-model="embyConfig.apiKey" placeholder="API Key" type="password" show-password size="default" class="no-border-input"> 
                            <template #prefix><el-icon><Key /></el-icon></template> 
                        </el-input> 
                    </div>
                    <div class="rounded-lg border px-2 py-1 bg-white/60 dark:bg-gray-900/40" style="border-color: var(--glass-border);">
                        <el-input v-model="embyConfig.tmdbId" placeholder="TMDB ID" size="default" class="no-border-input"> 
                            <template #prefix><el-icon><PriceTag /></el-icon></template> 
                        </el-input> 
                    </div>
                    
                    <el-button type="primary" class="w-full" @click="syncEmby" :loading="syncing" round> 
                        保存并同步 
                    </el-button> 

                    <div v-if="lastSyncTime" class="p-3 rounded-lg text-xs border transition-colors bg-gray-50/50 dark:bg-gray-800/30" 
                         style="border-color: var(--glass-border);"> 
                        <div class="flex justify-between items-center mb-1"> 
                            <span class="text-xs font-medium opacity-60" style="color: var(--text-secondary)">媒体库总数</span> 
                            <span class="font-bold" style="color: var(--text-primary)">{{ embyTotalCount }}</span> 
                        </div> 
                        <div class="flex justify-between items-center"> 
                            <span class="text-xs font-medium opacity-60" style="color: var(--text-secondary)">缺失集数</span> 
                            <span class="font-bold text-orange-500">{{ embyMissingList.length }}</span> 
                        </div> 
                    </div> 

                </div> 

                <el-divider style="border-color: var(--glass-border); opacity: 0.6; margin: 12px 0;"></el-divider> 
                
                <div class="rounded-xl border p-4 space-y-3 bg-gray-50/50 dark:bg-gray-800/30" style="border-color: var(--glass-border);"> 
                    <h3 class="text-xs font-medium opacity-60" style="color: var(--text-secondary)">系统控制</h3> 
                    
                    <div class="flex gap-2">
                        <el-button type="danger" plain class="flex-1" @click="triggerScrape" :loading="scraping" size="default" round>
                            全量抓取
                        </el-button>
                        
                        <div class="flex-1">
                            <el-popconfirm title="确定要清空所有数据吗？" @confirm="clearDatabase" width="200">
                                <template #reference>
                                    <el-button type="warning" plain class="w-full" size="default" round>清空数据库</el-button>
                                </template>
                            </el-popconfirm>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <div class="flex items-center rounded-lg overflow-hidden border bg-white/60 dark:bg-gray-900/40 flex-1" style="border-color: var(--glass-border);">
                            <el-input v-model="cronExpression" size="small" placeholder="Cron 表达式" class="no-border-input flex-1" input-style="text-align: center"></el-input>
                        </div>
                        <el-switch 
                            v-model="rssEnabled" 
                            class="rss-switch"
                            inline-prompt
                            active-text="定时RSS获取" 
                            inactive-text="定时RSS获取"
                            @change="updateCron" 
                            :loading="loadingCron" 
                            style="--el-switch-on-color: #13ce66" 
                        ></el-switch>
                    </div>
                </div> 
            </div> 

            <div class="h-48 p-4 m-4 mt-2 flex flex-col rounded-xl border transition-colors duration-300 bg-gray-900/90" 
                 style="border-color: var(--glass-border);"> 
                <div class="flex justify-between text-xs text-gray-400 mb-2 px-1"> 
                    <span class="font-mono">SYSTEM LOGS</span> 
                    <el-icon class="cursor-pointer hover:text-white transition-colors" @click="fetchLogs"><RefreshRight /></el-icon> 
                </div> 
                <div class="flex-1 overflow-auto font-mono text-xs text-green-400 whitespace-pre-wrap break-all leading-relaxed p-1 scrollbar-thin"> 
                    {{ logContent }} 
                </div> 
            </div> 
        </aside>

        <main class="flex-1 flex flex-col min-w-0 glass-container">
            <header class="px-6 py-3 flex justify-between items-center transition-all duration-300 z-50 sticky top-0"
                    style="background-color: var(--header-bg); border-bottom: 1px solid var(--glass-border); backdrop-filter: blur(12px);">
                
                <div class="flex items-center gap-4 flex-1 min-w-0 mr-4">
                    <el-button class="lg:hidden -ml-2 mr-2" circle text @click="isSidebarOpen = true">
                        <el-icon class="text-xl"><Expand /></el-icon>
                    </el-button>

                    <div class="text-sm text-gray-600 whitespace-nowrap flex-shrink-0 hidden sm:block">
                        <span style="color: var(--text-primary)">收录:</span>
                        <span class="font-bold text-lg mx-1" style="color: var(--text-blue)">{{ maxEpisode }}</span>
                        <span v-if="lastSyncTime" class="text-xs opacity-80" style="color: var(--text-secondary)">
                            (缺 <span class="text-orange-500 font-bold">{{ embyMissingList.length }}</span>)
                        </span>
                    </div>
                    
                    <el-input 
                        v-model="searchQuery" 
                        placeholder="搜索标题 / 文件名..." 
                        class="w-full max-w-xs"
                        clearable
                        size="default"
                    >
                        <template #prefix><el-icon><Search /></el-icon></template>
                    </el-input>
                </div>

                <div class="flex items-center gap-1 sm:gap-3 flex-shrink-0 px-2 py-1 sm:px-3 sm:py-1.5 rounded-full border bg-gray-100/50 dark:bg-gray-700/30" style="border-color: var(--glass-border);">
                    <el-button @click="copyAllMagnets" round size="default" class="!px-2 sm:!px-4">
                        <el-icon class="sm:mr-1"><CopyDocument /></el-icon> <span class="hidden sm:inline">复制所有磁链</span>
                    </el-button>
                    
                    <el-popover placement="bottom" width="320" trigger="click" @show="openPriorityPopover" :teleported="false" :show-arrow="false" popper-class="priority-popover">
                        <div class="rounded-xl border p-4 space-y-6 bg-gray-50/50 dark:bg-gray-800/30" style="border-color: var(--glass-border);">
                            <div class="flex items-center justify-between p-3 rounded-lg border bg-gray-50/50 dark:bg-gray-800/30" style="border-color: var(--glass-border);">
                                <span class="text-xs font-medium opacity-60" style="color: var(--text-secondary)">根据优先级设置筛选</span>
                                <el-switch
                                    v-model="smartFilterEnabled"
                                    style="--el-switch-on-color: #8b5cf6"
                                ></el-switch>
                            </div>

                            <div v-for="(label, key) in priorityLabels" :key="key">
                                <h4 class="text-xs font-medium opacity-60 mb-2" style="color: var(--text-secondary)">
                                    {{ label }}优先级
                                    <span class="font-normal opacity-50">(从上到下优先级递减)</span>
                                </h4>
                                <div class="border rounded-lg overflow-hidden bg-white/60 dark:bg-gray-900/40" style="border-color: var(--glass-border)">
                                    <template v-for="(item, index) in priorityConfig[key]" :key="item">
                                        <div v-if="item !== 'Unknown'" 
                                             class="flex items-center justify-between p-2 border-b last:border-0 transition-colors"
                                             style="border-color: var(--glass-border)"
                                             :class="{'bg-blue-50 dark:bg-blue-900/20': draggingState.category === key && draggingState.index === index}"
                                             draggable="true"
                                             @dragstart="onDragStart(key, index, $event)"
                                             @dragover.prevent="onDragOver(key, index, $event)"
                                             @drop="onDrop(key, index, $event)"
                                             @dragend="onDragEnd">
                                            <span class="text-xs font-mono">{{ item }}</span>
                                            <div class="flex gap-1 cursor-move text-gray-400 hover:text-gray-600">
                                                <el-icon><Rank /></el-icon>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                        <template #reference>
                            <el-button round size="default" plain class="!px-2 sm:!px-4">
                                <el-icon class="sm:mr-1"><Operation /></el-icon> <span class="hidden sm:inline">排序设置</span>
                            </el-button>
                        </template>
                    </el-popover>
                    
                    <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-0.5 sm:mx-1"></div>

                    <el-switch 
                        v-model="isEmbyMode" 
                        class="hidden sm:inline-flex"
                        active-text="仅媒体库缺失" 
                        inactive-text="全部条目"
                        style="--el-switch-on-color: #f97316" 
                    ></el-switch>
                    <el-switch 
                        v-model="isEmbyMode" 
                        class="sm:hidden"
                        style="--el-switch-on-color: #f97316" 
                    ></el-switch>
                    
                    <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-0.5 sm:mx-1"></div>
                    
                    <el-button round @click="toggleTheme" style="background: transparent; border: 1px solid var(--glass-border); color: var(--text-primary);" class="!px-2 sm:!px-4">
                        <el-icon class="sm:mr-1" :size="16">
                            <component :is="isDark ? 'Sunny' : 'Moon'"></component>
                        </el-icon>
                        <span class="hidden sm:inline">切换主题</span>
                    </el-button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 scroll-smooth">
                <div class="max-w-6xl mx-auto space-y-4">
                    <template v-for="ep in paginatedEpisodes" :key="ep.num">
                        
                        <div v-if="ep.data.length > 0" class="resource-card rounded-xl shadow-sm overflow-hidden mb-6" 
                             :class="{'ring-2 ring-orange-400 bg-orange-50/50': isEmbyMode && (!lastSyncTime || embyMissingList.includes(ep.num))}">
                            
                            <div class="resource-card-header px-4 py-3 flex items-center justify-between border-b" style="border-color: var(--card-border); background: var(--header-bg);">
                                <div class="flex items-center gap-3 overflow-hidden min-w-0">
                                    <span class="text-xl font-black whitespace-nowrap flex-shrink-0" style="color: var(--text-blue)">第 {{ ep.num }} 集</span>
                                    
                                    <div class="hidden sm:flex items-baseline gap-3 overflow-hidden min-w-0">
                                        <span class="text-base font-bold truncate" style="color: var(--text-primary)" :title="ep.data[0].episode_title">
                                            {{ ep.data[0].episode_title || cleanTitle(ep.data[0].raw_title, ep.num) }}
                                        </span>
                                        <span class="text-xs whitespace-nowrap flex-shrink-0 font-mono opacity-80" style="color: var(--text-secondary)">
                                            {{ ep.data[0].publish_date }}
                                        </span>
                                    </div>
                                </div>
                                
                                <el-tag size="small" type="info" class="flex-shrink-0 ml-2">{{ ep.data.length }} 个资源</el-tag>
                            </div>
                        
                            <div class="divide-y" style="border-color: var(--card-border)">
                                <div v-for="(res, idx) in ep.data" :key="idx" class="resource-row p-3 flex items-center gap-4 group hover:bg-gray-50 transition-colors" style="border-bottom: 1px solid var(--card-border)">
                                    
                                    <div class="flex items-center gap-2 flex-wrap flex-shrink-0">
                                        <el-tag v-if="res.resolution" size="small" :type="res.resolution.includes('1080') ? 'success' : 'warning'" effect="light">
                                            {{ res.resolution }}
                                        </el-tag>
                                        <el-tag v-if="res.subtitle && res.subtitle !== 'Unknown'" size="small" color="transparent" style="color: var(--text-blue); border-color: var(--card-border);">
                                            {{ res.subtitle }}
                                        </el-tag>
                                        <el-tag v-if="res.source_type" size="small" type="danger" effect="plain" class="font-bold">
                                            {{ res.source_type }}
                                        </el-tag>
                                        <el-tag v-if="res.container" size="small" type="info" effect="plain" class="font-mono">
                                            {{ res.container }}
                                        </el-tag>
                                    </div>
                        
                                    <div class="flex-1 min-w-0 flex items-center text-gray-400 opacity-60 group-hover:opacity-100 transition-opacity">
                                        <el-icon class="mr-1.5 flex-shrink-0"><Paperclip /></el-icon>
                                        <span class="text-xs font-mono truncate cursor-text select-all" :title="res.raw_title">
                                           {{ res.raw_title.replace(/^\[.*?\]\[.*?\]\[.*?\]/, '').trim() || res.raw_title }}
                                        </span>
                                    </div>
                        
                                    <div class="flex items-center flex-shrink-0 pl-4">
                                        <el-button type="primary" size="small" round @click="copyMagnet(res.magnet_link)" title="复制磁力链接">
                                            复制
                                        </el-button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-else class="border-2 border-dashed rounded-xl p-4 flex items-center justify-center opacity-60" style="border-color: var(--card-border); background-color: var(--tag-info-bg)">
                            <span class="font-mono mr-2" style="color: var(--text-secondary)">Episode {{ ep.num }}</span>
                            <span class="text-xs px-2 py-0.5 rounded" style="color: var(--text-secondary); background-color: var(--card-border)">暂无收录</span>
                        </div>

                    </template>
                </div>
                <div class="flex justify-center mt-8 pb-8">
                    <el-pagination
                        v-model:current-page="currentPage"
                        v-model:page-size="pageSize"
                        :page-sizes="[12, 24, 48, 100]"
                        layout="total, sizes, prev, pager, next, jumper"
                        :total="filteredTotal"
                        background
                        @current-change="scrollToTop"
                    />
                </div>
            </div>
        </main>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        const { ElMessage, ElNotification } = ElementPlus;

        const app = createApp({
            setup() {
                // 主题相关
                const isDark = ref(false);
                const isSidebarOpen = ref(false);
                const toggleTheme = () => {
                    isDark.value = !isDark.value;
                    updateTheme();
                };
                const updateTheme = () => {
                    const html = document.documentElement;
                    if (isDark.value) {
                        html.setAttribute('data-theme', 'dark');
                        html.classList.add('dark'); // for Tailwind
                        localStorage.setItem('theme', 'dark');
                    } else {
                        html.setAttribute('data-theme', 'light');
                        html.classList.remove('dark'); // for Tailwind
                        localStorage.setItem('theme', 'light');
                    }
                };

                // 初始化主题
                onMounted(() => {
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme) {
                        isDark.value = savedTheme === 'dark';
                    } else {
                        // 如果没有保存过，检测系统偏好
                        isDark.value = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    }
                    updateTheme();
                    
                    // 读取本地存储配置
                    const savedConfig = localStorage.getItem('project4869_emby_config');
                    if (savedConfig) embyConfig.value = JSON.parse(savedConfig);

                    // 设置 Element Plus 语言为中文
                    app.use(ElementPlus, { locale: ElementPlusLocaleZhCn });
                    fetchData();
                    fetchLogs(); // 初始加载日志
                    setInterval(fetchLogs, 5000); // 每5秒自动刷新日志
                });


                const magnets = ref([]);
                const groupedData = ref({});
                const maxEpisode = ref(0);
                const cronExpression = ref("0 */1 * * *");
                const rssEnabled = ref(false);
                const loadingCron = ref(false);
                const scraping = ref(false);
                const showLogs = ref(false);
                const logContent = ref("正在加载日志...");
                const filterType = ref("all");
                const searchQuery = ref(""); // 新增搜索变量
                const isEmbyMode = ref(false);
                const embyMissingList = ref([]);
                const embyTotalCount = ref(0);
                const lastSyncTime = ref("");

                // --- 智能精选与排序逻辑 ---
                const smartFilterEnabled = ref(false);
                
                // 默认优先级配置
                const defaultPriority = {
                    resolution: ['1080P', '1080p', '720P', '720p', '4K', '2160P', 'Unknown'],
                    subtitle: ['简日双语', '简日', '繁日', 'CHS_JP', 'Unknown'],
                    source_type: ['WEBRIP', 'WebRip', 'BDRIP', 'BDRip', 'HDTV', 'Unknown'],
                    container: ['MP4', 'mp4', 'MKV', 'mkv', 'Unknown']
                };
                
                const priorityConfig = ref(JSON.parse(JSON.stringify(defaultPriority)));
                
                const priorityLabels = {
                    resolution: '分辨率',
                    subtitle: '字幕',
                    source_type: '来源',
                    container: '容器'
                };

                // 加载保存的配置
                onMounted(() => {
                    const savedPriority = localStorage.getItem('project4869_priority_config');
                    if (savedPriority) {
                        try {
                            const parsed = JSON.parse(savedPriority);
                            priorityConfig.value = { ...defaultPriority, ...parsed };
                        } catch(e) { console.error(e); }
                    }
                });

                watch(priorityConfig, (newVal) => {
                    localStorage.setItem('project4869_priority_config', JSON.stringify(newVal));
                }, { deep: true });

                const openPriorityPopover = async () => {
                    try {
                        const res = await fetch('/api/options');
                        const json = await res.json();
                        
                        if (json.error) {
                            ElMessage.error('获取选项失败: ' + json.error);
                            return;
                        }

                        // 合并逻辑：保留用户已排序的顺序，追加新选项
                        const newConfig = { ...priorityConfig.value };
                        
                        for (const key in json) {
                            const dbOptions = json[key]; // 数据库返回的最新选项列表
                            const currentList = newConfig[key] || [];
                            
                            // 1. 过滤掉 currentList 中已经不存在于 dbOptions 的项 (除了 'Unknown')
                            // 但是用户可能希望保留之前的配置即使暂时没有数据？
                            // 策略：保留所有当前配置中的项，只要它们不是完全无效的。
                            // 但为了响应“实时获取”，应该以 dbOptions 为准，加上 Unknown。
                            
                            // 更好的策略：
                            // 1. 提取 currentList 中所有在 dbOptions + ['Unknown'] 中的项，保持顺序。
                            // 2. 将 dbOptions 中未出现在 currentList 的项追加到后面。
                            
                            const validSet = new Set([...dbOptions, 'Unknown']);
                            
                            // 步骤 1: 保留已有的且有效的
                            const mergedList = currentList.filter(item => validSet.has(item));
                            
                            // 步骤 2: 追加新的
                            dbOptions.forEach(opt => {
                                if (!mergedList.includes(opt)) {
                                    mergedList.push(opt);
                                }
                            });
                            
                            // 确保 Unknown 存在
                            if (!mergedList.includes('Unknown')) {
                                mergedList.push('Unknown');
                            }
                            
                            newConfig[key] = mergedList;
                        }
                        
                        priorityConfig.value = newConfig;
                        
                    } catch (e) {
                        console.error(e);
                        ElMessage.error('无法获取最新选项');
                    }
                };

                const movePriority = (category, index, direction) => {
                    const arr = priorityConfig.value[category];
                    if (direction === -1 && index > 0) {
                        [arr[index], arr[index - 1]] = [arr[index - 1], arr[index]];
                    } else if (direction === 1 && index < arr.length - 1) {
                        [arr[index], arr[index + 1]] = [arr[index + 1], arr[index]];
                    }
                };

                // --- Drag and Drop Logic ---
                const draggingState = ref({ category: null, index: null });

                const onDragStart = (category, index, event) => {
                    draggingState.value = { category, index };
                    event.dataTransfer.effectAllowed = 'move';
                    // Optional: set drag image or data if needed
                };

                const onDragOver = (category, index, event) => {
                    // Only allow dropping if same category
                    if (draggingState.value.category === category) {
                         // Default is usually 'copy', we want 'move' visual
                         event.dataTransfer.dropEffect = 'move';
                    }
                };

                const onDrop = (category, index, event) => {
                    const srcState = draggingState.value;
                    
                    // Validation: must be same category and valid indices
                    if (srcState.category !== category || srcState.index === null) return;
                    if (srcState.index === index) return; // Dropped on self

                    const list = priorityConfig.value[category];
                    const srcIndex = srcState.index;
                    const destIndex = index;

                    // Remove item from source
                    const [movedItem] = list.splice(srcIndex, 1);
                    // Insert at destination
                    list.splice(destIndex, 0, movedItem);
                    
                    // Reset state
                    onDragEnd();
                };

                const onDragEnd = () => {
                    draggingState.value = { category: null, index: null };
                };
                
                const compareResources = (a, b) => {
                    const categories = ['resolution', 'subtitle', 'source_type', 'container'];
                    for (const cat of categories) {
                        const list = priorityConfig.value[cat];
                        const valA = a[cat] || 'Unknown';
                        const valB = b[cat] || 'Unknown';
                        
                        let idxA = list.findIndex(item => valA.includes(item) || item.includes(valA));
                        let idxB = list.findIndex(item => valB.includes(item) || item.includes(valB));
                        
                        if (idxA === -1) idxA = 999;
                        if (idxB === -1) idxB = 999;
                        
                        if (idxA !== idxB) return idxA - idxB;
                    }
                    return 0;
                };
                
                // Emby 配置
                const embyConfig = ref({ host: '', apiKey: '', tmdbId: '30983' });
                const syncing = ref(false);

                // 分页状态
                const currentPage = ref(1);
                const pageSize = ref(24);

                const syncEmby = async () => {
                    if (!embyConfig.value.host || !embyConfig.value.apiKey) {
                        ElMessage.warning('请先填写 Host 和 API Key');
                        return;
                    }
                    
                    syncing.value = true;
                    // 保存配置到浏览器
                    localStorage.setItem('project4869_emby_config', JSON.stringify(embyConfig.value));
                    
                    try {
                        const res = await fetch('/api/emby/missing', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                host: embyConfig.value.host,
                                api_key: embyConfig.value.apiKey,
                                tmdb_id: embyConfig.value.tmdbId,
                                max_episode: maxEpisode.value
                            })
                        });
                        const json = await res.json();
                        
                        if (json.error) {
                            ElMessage.error(json.error);
                        } else {
                            embyMissingList.value = json.missing_episodes;
                            embyTotalCount.value = json.total_count || 0;
                            lastSyncTime.value = new Date().toLocaleTimeString();
                            
                            if (json.missing_episodes.length > 0) {
                                ElMessage.success(`同步成功，发现 ${json.missing_episodes.length} 集缺失`);
                                isEmbyMode.value = true; // 自动开启筛选
                            } else {
                                ElMessage.success('同步成功，您的媒体库是完整的！');
                                isEmbyMode.value = false;
                            }
                        }
                    } catch (e) {
                        ElMessage.error('网络请求失败');
                    } finally {
                        syncing.value = false;
                    }
                };

                const cleanTitle = (raw, epNum) => {
                    if (!raw) return "";
                    let title = raw;
                    const removePatterns = [
                        /\[银色子弹字幕组\]/g, /\[银色子弹\]/g, /\[SilverBullet\]/g,
                        /\[名侦探柯南\]/g, /\[名探偵コナン\]/g, /\[Detective Conan\]/g, /\[Conan\]/g,
                        /\[SBSUB\]/g
                    ];
                    removePatterns.forEach(p => title = title.replace(p, ''));
                    if (epNum) {
                        const epPatterns = [
                            new RegExp(`\\[${epNum}\\]`, 'g'),
                            new RegExp(`第${epNum}(集|话)`, 'g'),
                            new RegExp(`\\s${epNum}\\s`, 'g')
                        ];
                        epPatterns.forEach(p => title = title.replace(p, ''));
                    }
                    const techPatterns = [
                        /\[1080[Pp]\]/gi, /\[720[Pp]\]/gi, /\[4[Kk]\]/gi,
                        /\[WEBRIP\]/gi, /\[BDRIP\]/gi, /\[HDTV\]/gi,
                        /\[MP4\]/gi, /\[MKV\]/gi,
                        /\[简日双语\]/g, /\[简日\]/g, /\[繁日\]/g, /\[CHS_JP\]/g
                    ];
                    techPatterns.forEach(p => title = title.replace(p, ''));
                    title = title.replace(/\[\s*\]/g, '').replace(/【\s*】/g, '').replace(/\(\s*\)/g, '').trim();
                    if (/^[-.]+$/.test(title)) return "";
                    return title;
                };

                const fetchData = async () => {
                    try {
                        const res = await fetch('/api/magnets');
                        const json = await res.json();
                        
                        if (json.error) {
                            console.error("API Error:", json.error);
                            // 如果是表不存在的错误，可能还没初始化，不弹窗打扰用户，只是保持空状态
                            if (!json.error.includes('no such table')) {
                                ElMessage.error(json.error);
                            }
                            magnets.value = [];
                            groupedData.value = {};
                            return;
                        }

                        magnets.value = json.data || [];
                        maxEpisode.value = json.max_episode || 0;
                        groupedData.value = json.grouped_by_episode || {};
                    } catch (e) {
                        ElMessage.error('无法连接到服务器');
                        console.error(e);
                    }
                };

                const filteredEpisodes = computed(() => {
                    const list = [];
                    const start = maxEpisode.value > 0 ? maxEpisode.value : 1;
                    
                    // 预处理搜索关键字
                    let keywords = [];
                    if (searchQuery.value) {
                        keywords = searchQuery.value.toLowerCase().split(/\s+/).filter(k => k);
                    }

                    for (let i = start; i >= 1; i--) {
                        const data = groupedData.value[i] || [];
                        
                        // 1. Emby 模式筛选
                        if (isEmbyMode.value && lastSyncTime.value && !embyMissingList.value.includes(i)) continue;
                        
                        // 2. 搜索关键字筛选
                        if (keywords.length > 0) {
                            // 构建可搜索文本：集数 + 纯标题 + 所有文件名 + 所有标签信息
                            // 注意：cleanTitle 可能依赖 data[0]，如果 data 为空需要处理
                            const epTitle = data.length > 0 ? (data[0].episode_title || cleanTitle(data[0].raw_title, i)) : "";
                            const fileNames = data.map(d => d.raw_title).join(" ");
                            
                            // 显式添加标签信息 (分辨率、字幕、来源、容器)
                            const tagInfo = data.map(d => {
                                return [d.resolution, d.subtitle, d.source_type, d.container]
                                    .filter(t => t && t !== 'Unknown') // 过滤掉无效值
                                    .join(" ");
                            }).join(" ");

                            const searchableText = `${i} ${epTitle} ${fileNames} ${tagInfo}`.toLowerCase();
                            
                            // 必须包含所有关键字
                            const match = keywords.every(kw => searchableText.includes(kw));
                            if (!match) continue;
                        }

                        // 3. 原有的筛选逻辑 (虽无 UI 触发，保留逻辑)
                        const exists = data.length > 0;
                        if (filterType.value === 'existing' && !exists) continue;
                        if (filterType.value === 'missing' && exists) continue;

                        // 4. 智能筛选
                        if (smartFilterEnabled.value && data.length > 0) {
                            const sortedData = [...data].sort(compareResources);
                            list.push({ num: i, data: [sortedData[0]] });
                        } else {
                            list.push({ num: i, data: data });
                        }
                    }
                    return list;
                });

                const filteredTotal = computed(() => filteredEpisodes.value.length);

                const paginatedEpisodes = computed(() => {
                    const start = (currentPage.value - 1) * pageSize.value;
                    const end = start + pageSize.value;
                    return filteredEpisodes.value.slice(start, end);
                });

                const scrollToTop = () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const triggerScrape = async () => {
                    scraping.value = true;
                    try {
                        await fetch('/api/scrape/full', { method: 'POST' });
                        ElNotification({
                            title: '任务已提交',
                            message: '全量爬虫正在后台运行，请稍后刷新查看结果',
                            type: 'success',
                        });
                    } catch (e) {
                        ElMessage.error('请求失败');
                    } finally {
                        setTimeout(() => { scraping.value = false; }, 2000);
                    }
                };

                const updateCron = async (newVal) => {
                    // 只在试图打开开关时进行校验
                    if (newVal === true) {
                        if (!cronExpression.value || !cronExpression.value.trim()) {
                            ElMessage.warning('请先填写 Cron 表达式');
                            rssEnabled.value = false; // 回滚状态
                            return;
                        }
                    }

                    loadingCron.value = true;
                    try {
                        const res = await fetch('/api/rss/config', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                cron_expression: cronExpression.value,
                                enabled: rssEnabled.value
                            })
                        });
                        const json = await res.json();
                        if (res.ok) {
                            ElMessage.success(json.message);
                        } else {
                            ElMessage.error(json.error || '更新失败');
                            // 如果是开启失败，则回滚开关
                            if (rssEnabled.value) rssEnabled.value = false;
                        }
                    } catch (e) {
                        ElMessage.error('请求失败');
                        // 如果是开启失败，则回滚开关
                        if (rssEnabled.value) rssEnabled.value = false;
                    } finally {
                        loadingCron.value = false;
                    }
                };

                const clearDatabase = async () => {
                    try {
                        const res = await fetch('/api/database', { method: 'DELETE' });
                        if (res.ok) {
                            ElMessage.success('数据库已清空');
                            magnets.value = [];
                            maxEpisode.value = 0;
                            groupedData.value = {};
                        } else {
                            ElMessage.error('清空失败');
                        }
                    } catch (e) {
                        ElMessage.error('请求失败');
                    }
                };

                const fetchLogs = async () => {
                    try {
                        const res = await fetch('/api/system/logs');
                        const json = await res.json();
                        logContent.value = json.logs.reverse().join('');
                    } catch (e) {
                        logContent.value = "无法获取日志";
                    }
                };

                const copyToClipboard = (text) => {
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        return navigator.clipboard.writeText(text);
                    } else {
                        return new Promise((resolve, reject) => {
                            try {
                                const textArea = document.createElement("textarea");
                                textArea.value = text;
                                
                                // Ensure it's not visible but part of the DOM
                                textArea.style.position = "fixed";
                                textArea.style.left = "-9999px";
                                textArea.style.top = "0";
                                document.body.appendChild(textArea);
                                
                                textArea.focus();
                                textArea.select();
                                
                                const successful = document.execCommand('copy');
                                document.body.removeChild(textArea);
                                
                                if (successful) resolve();
                                else reject(new Error("execCommand failed"));
                            } catch (err) {
                                reject(err);
                            }
                        });
                    }
                };

                const copyMagnet = (link) => {
                    copyToClipboard(link).then(() => {
                        ElMessage({ message: '磁力链接已复制', type: 'success', duration: 1500 });
                    }).catch((err) => {
                        console.error('Copy failed', err);
                        ElMessage.error('复制失败，请手动复制');
                    });
                };

                const copyAllMagnets = () => {
                     let links = [];
                     filteredEpisodes.value.forEach(ep => {
                         ep.data.forEach(res => {
                             if (res.magnet_link) links.push(res.magnet_link);
                         });
                     });
                     
                     if (links.length === 0) {
                         ElMessage.warning('当前列表没有可复制的磁力链接');
                         return;
                     }
                     
                     const text = links.join('\n');
                     copyToClipboard(text).then(() => {
                         ElMessage.success(`已复制 ${links.length} 条磁力链接`);
                     }).catch((err) => {
                         console.error('Copy all failed', err);
                         ElMessage.error('复制失败，请手动复制');
                     });
                };

                return {
                    isDark,
                    isSidebarOpen,
                    toggleTheme,
                    smartFilterEnabled,
                    openPriorityPopover,
                    priorityConfig,
                    priorityLabels,
                    movePriority,
                    draggingState,
                    onDragStart,
                    onDragOver,
                    onDrop,
                    onDragEnd,
                    copyAllMagnets,
                    magnets,
                    maxEpisode,
                    cronExpression,
                    rssEnabled,
                    loadingCron,
                    updateCron,
                    clearDatabase,
                    scraping,
                    triggerScrape,
                    showLogs,
                    logContent,
                    fetchLogs,
                    filterType,
                    isEmbyMode,
                    embyMissingList,
                    embyTotalCount,
                    embyConfig,
                    syncEmby,
                    syncing,
                    lastSyncTime,
                    cleanTitle,
                    copyMagnet,
                    paginatedEpisodes,
                    filteredTotal,
                    currentPage,
                    pageSize,
                    scrollToTop,
                    searchQuery // 导出 searchQuery
                };
            }
        });

        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.mount('#app');
    </script>
</body>
</html>
