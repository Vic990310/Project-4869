<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project-4869: 名侦探柯南资源管理</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus/dist/index.full.js"></script>
    <script src="https://unpkg.com/element-plus/dist/locale/zh-cn.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>

    <script src="https://unpkg.com/@element-plus/icons-vue"></script>

    <style>
        /* --- CSS 变量定义主题 --- */
        :root {
            /* 亮色模式默认值 */
            --bg-image: url('/static/bg-light.jpg');
            --bg-position: left center;
            --bg-overlay: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.2) 100%);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.6);
            
            --text-primary: #1f2937;   /* gray-800 */
            --text-secondary: #6b7280; /* gray-500 */
            --text-blue: #1e40af;      /* blue-800 */
            
            --card-bg: #ffffff;
            --card-border: #f3f4f6;    /* gray-100 */
            --header-bg: rgba(255, 255, 255, 0.9);
            
            --tag-info-bg: #f4f4f5;
            --tag-info-text: #909399;
        }

        /* 暗色模式重写 */
        html[data-theme="dark"] {
            --bg-image: url('/static/bg-dark.jpg');
            --bg-position: right center;
            /* 暗色模式叠加一层深色渐变，让文字更清晰 */
            --bg-overlay: linear-gradient(135deg, rgba(17, 24, 39, 0.7) 0%, rgba(17, 24, 39, 0.5) 100%);
            /* 深色毛玻璃 */
            --glass-bg: rgba(17, 24, 39, 0.25);
            --glass-border: rgba(255, 255, 255, 0.1);
            
            --text-primary: #f9fafb;   /* gray-50 */
            --text-secondary: #9ca3af; /* gray-400 */
            --text-blue: #60a5fa;      /* blue-400 */
            
            --card-bg: #1f2937;        /* gray-800 */
            --card-border: #374151;    /* gray-700 */
            --header-bg: rgba(17, 24, 39, 0.9);

            --tag-info-bg: #374151;
            --tag-info-text: #d1d5db;
        }

        body {
            margin: 0;
            font-family: 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background-color: var(--glass-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .bg-wallpaper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--bg-overlay), var(--bg-image);
            background-size: cover;
            background-position: var(--bg-position);
            z-index: -1;
            transition: background-image 0.3s, background-position 0.3s;
        }
        .glass-container {
            background: var(--glass-bg);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            min-height: 100vh;
            border-right: 1px solid var(--glass-border);
            border-left: 1px solid var(--glass-border);
        }
        /* 头部导航 */
        .top-nav {
            background-color: var(--header-bg);
            border-bottom: 1px solid var(--glass-border);
        }
        /* 统计卡片 */
        .stats-card {
            background-color: var(--header-bg);
            border: 1px solid var(--glass-border);
        }
        
        /* 移除输入框边框，用于融合控件 */
        .no-border-input .el-input__wrapper {
            box-shadow: none !important;
            background-color: transparent !important;
            padding-left: 0;
        }
        /* 资源卡片 */
        .resource-card {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
        }
        .resource-card-header {
            background-color: var(--card-border); /* 稍微深一点的头部背景 */
            border-bottom: 1px solid var(--card-border);
        }
        .resource-row {
            transition: all 0.2s;
            border-color: var(--card-border);
        }
        .resource-row:hover {
            /* 暗色模式下的悬停高亮需要特殊处理 */
            background-color: rgba(59, 130, 246, 0.1); /* blue-500 with opacity */
        }
        /* 分页器样式优化 */
        .el-pagination {
            justify-content: center;
            margin-top: 2rem;
            padding: 1rem;
            background: var(--header-bg);
            border-radius: 1rem;
            backdrop-filter: blur(5px);
            border: 1px solid var(--glass-border);
        }
        /* 暗色模式下 Element Plus 的一些微调 */
        html[data-theme="dark"] .el-tag--info {
            --el-tag-bg-color: var(--tag-info-bg);
            --el-tag-border-color: var(--card-border);
            --el-tag-text-color: var(--tag-info-text);
        }
        html[data-theme="dark"] .el-radio-button__inner {
            background: var(--card-bg);
            color: var(--text-secondary);
            border-color: var(--card-border);
        }
        html[data-theme="dark"] .el-radio-button:first-child .el-radio-button__inner {
            border-left-color: var(--card-border);
        }
        html[data-theme="dark"] .el-drawer {
            background: var(--card-bg) !important;
        }
        html[data-theme="dark"] .el-drawer__title {
            color: var(--text-primary) !important;
        }
    </style>
</head>
<body>
    <div id="app" class="h-screen flex overflow-hidden">
        <div class="bg-wallpaper"></div>
        
        <aside class="w-72 flex flex-col border-r z-20 flex-shrink-0 transition-colors duration-300" 
               style="background-color: var(--glass-bg); border-color: var(--glass-border); backdrop-filter: blur(20px);"> 
            
            <div class="p-6 border-b transition-colors duration-300" style="border-color: var(--glass-border);"> 
                <h1 class="text-xl font-bold flex items-center gap-2" style="color: var(--text-blue)"> 
                    <el-icon><Monitor /></el-icon> Project-4869 
                </h1> 
            </div> 

            <div class="p-5 flex-1 overflow-y-auto space-y-5"> 
                
                <div class="space-y-3"> 
                    <h3 class="text-xs font-bold uppercase tracking-wider opacity-60" style="color: var(--text-secondary)">Emby 连接</h3> 
                    
                    <el-input v-model="embyConfig.host" placeholder="http://ip:8096" size="default"> 
                        <template #prefix><el-icon><Link /></el-icon></template> 
                    </el-input> 
                    <el-input v-model="embyConfig.apiKey" placeholder="API Key" type="password" show-password size="default"> 
                        <template #prefix><el-icon><Key /></el-icon></template> 
                    </el-input> 
                    <el-input v-model="embyConfig.tmdbId" placeholder="TMDB ID" size="default"> 
                        <template #prefix><el-icon><PriceTag /></el-icon></template> 
                    </el-input> 
                    
                    <el-button type="primary" class="w-full" @click="syncEmby" :loading="syncing" round> 
                        保存并同步 
                    </el-button> 

                    <div v-if="lastSyncTime" class="p-3 rounded-lg text-xs border transition-colors" 
                         style="background-color: var(--tag-info-bg); border-color: var(--glass-border);"> 
                        <div class="flex justify-between items-center mb-1"> 
                            <span class="opacity-70">媒体库总数</span> 
                            <span class="font-bold" style="color: var(--text-primary)">{{ embyTotalCount }}</span> 
                        </div> 
                        <div class="flex justify-between items-center"> 
                            <span class="opacity-70">缺失集数</span> 
                            <span class="font-bold text-orange-500">{{ embyMissingList.length }}</span> 
                        </div> 
                    </div> 
                </div> 

                <el-divider style="border-color: var(--glass-border); opacity: 0.6; margin: 12px 0;"></el-divider> 
                
                <div class="space-y-3"> 
                    <h3 class="text-xs font-bold uppercase tracking-wider opacity-60" style="color: var(--text-secondary)">系统控制</h3> 
                    
                    <div class="flex gap-2">
                        <el-button type="danger" plain class="flex-1" @click="triggerScrape" :loading="scraping" size="default" round>
                            全量抓取
                        </el-button>
                        
                        <div class="flex-1">
                            <el-popconfirm title="确定要清空所有数据吗？" @confirm="clearDatabase" width="200">
                                <template #reference>
                                    <el-button type="warning" plain class="w-full" size="default" round>清空数据库</el-button>
                                </template>
                            </el-popconfirm>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 p-2 rounded-lg border transition-colors" 
                         style="background-color: var(--tag-info-bg); border-color: var(--glass-border);">
                        <el-input v-model="cronExpression" size="small" placeholder="Cron" style="flex: 1;" class="no-border-input"></el-input>
                        <el-switch 
                            v-model="rssEnabled" 
                            inline-prompt 
                            active-text="ON" 
                            inactive-text="OFF" 
                            @change="updateCron" 
                            :loading="loadingCron" 
                            style="--el-switch-on-color: #13ce66" 
                        ></el-switch>
                    </div>
                </div> 
            </div> 

            <div class="h-48 p-3 flex flex-col border-t transition-colors duration-300" 
                 style="background-color: rgba(17, 24, 39, 0.95); border-color: var(--glass-border);"> 
                <div class="flex justify-between text-xs text-gray-400 mb-2 px-1"> 
                    <span class="font-mono">SYSTEM LOGS</span> 
                    <el-icon class="cursor-pointer hover:text-white transition-colors" @click="fetchLogs"><RefreshRight /></el-icon> 
                </div> 
                <div class="flex-1 overflow-auto font-mono text-xs text-green-400 whitespace-pre-wrap break-all leading-relaxed p-1 scrollbar-thin"> 
                    {{ logContent }} 
                </div> 
            </div> 
        </aside>

        <main class="flex-1 flex flex-col min-w-0 glass-container">
            <header class="px-6 py-3 flex justify-between items-center transition-all duration-300 z-50 sticky top-0"
                    style="background-color: var(--header-bg); border-bottom: 1px solid var(--glass-border); backdrop-filter: blur(12px);">
                
                <div class="flex items-center gap-4 flex-1 min-w-0 mr-4">
                    <div class="text-sm text-gray-600 whitespace-nowrap flex-shrink-0 hidden sm:block">
                        <span style="color: var(--text-primary)">收录:</span>
                        <span class="font-bold text-lg mx-1" style="color: var(--text-blue)">{{ maxEpisode }}</span>
                        <span v-if="lastSyncTime" class="text-xs opacity-80" style="color: var(--text-secondary)">
                            (缺 <span class="text-orange-500 font-bold">{{ embyMissingList.length }}</span>)
                        </span>
                    </div>
                    
                    <el-input 
                        v-model="searchQuery" 
                        placeholder="搜索标题 / 文件名..." 
                        class="w-full max-w-xs"
                        clearable
                        size="default"
                    >
                        <template #prefix><el-icon><Search /></el-icon></template>
                    </el-input>
                </div>

                <div class="flex items-center gap-3 flex-shrink-0">
                    <el-switch 
                        v-model="isEmbyMode" 
                        active-text="仅缺失" 
                        inline-prompt 
                        style="--el-switch-on-color: #f97316" 
                    ></el-switch> <div class="h-4 w-px bg-gray-300 dark:bg-gray-600 mx-1"></div>
                    
                    <el-button circle @click="toggleTheme" title="切换主题" style="background: transparent; border: 1px solid var(--glass-border); color: var(--text-primary);">
                        <template #icon>
                            <el-icon :size="16">
                                <component :is="isDark ? Sunny : Moon"></component>
                            </el-icon>
                        </template>
                    </el-button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-6 scroll-smooth">
                <div class="max-w-6xl mx-auto space-y-4">
                    <template v-for="ep in paginatedEpisodes" :key="ep.num">
                        
                        <div v-if="ep.data.length > 0" class="resource-card rounded-xl shadow-sm overflow-hidden mb-6" 
                             :class="{'ring-2 ring-orange-400 bg-orange-50/50': isEmbyMode && (!lastSyncTime || embyMissingList.includes(ep.num))}">
                            
                            <div class="resource-card-header px-4 py-3 flex items-center justify-between border-b" style="border-color: var(--card-border); background: var(--header-bg);">
                                <div class="flex items-center gap-3 overflow-hidden min-w-0">
                                    <span class="text-xl font-black whitespace-nowrap flex-shrink-0" style="color: var(--text-blue)">第 {{ ep.num }} 集</span>
                                    
                                    <div class="flex items-baseline gap-3 overflow-hidden min-w-0">
                                        <span class="text-base font-bold truncate" style="color: var(--text-primary)" :title="ep.data[0].episode_title">
                                            {{ ep.data[0].episode_title || cleanTitle(ep.data[0].raw_title, ep.num) }}
                                        </span>
                                        <span class="text-xs whitespace-nowrap flex-shrink-0 font-mono opacity-80" style="color: var(--text-secondary)">
                                            {{ ep.data[0].publish_date }}
                                        </span>
                                    </div>
                                </div>
                                
                                <el-tag size="small" type="info" class="flex-shrink-0 ml-2">{{ ep.data.length }} 个资源</el-tag>
                            </div>
                        
                            <div class="divide-y" style="border-color: var(--card-border)">
                                <div v-for="(res, idx) in ep.data" :key="idx" class="resource-row p-3 flex items-center gap-4 group hover:bg-gray-50 transition-colors" style="border-bottom: 1px solid var(--card-border)">
                                    
                                    <div class="flex items-center gap-2 flex-wrap flex-shrink-0">
                                        <el-tag v-if="res.resolution" size="small" :type="res.resolution.includes('1080') ? 'success' : 'warning'" effect="light">
                                            {{ res.resolution }}
                                        </el-tag>
                                        <el-tag v-if="res.subtitle && res.subtitle !== 'Unknown'" size="small" color="transparent" style="color: var(--text-blue); border-color: var(--card-border);">
                                            {{ res.subtitle }}
                                        </el-tag>
                                        <el-tag v-if="res.source_type" size="small" type="danger" effect="plain" class="font-bold">
                                            {{ res.source_type }}
                                        </el-tag>
                                        <el-tag v-if="res.container" size="small" type="info" effect="plain" class="font-mono">
                                            {{ res.container }}
                                        </el-tag>
                                    </div>
                        
                                    <div class="flex-1 min-w-0 flex items-center text-gray-400 opacity-60 group-hover:opacity-100 transition-opacity">
                                        <el-icon class="mr-1.5 flex-shrink-0"><Paperclip /></el-icon>
                                        <span class="text-xs font-mono truncate cursor-text select-all" :title="res.raw_title">
                                           {{ res.raw_title.replace(/^\[.*?\]\[.*?\]\[.*?\]/, '').trim() || res.raw_title }}
                                        </span>
                                    </div>
                        
                                    <div class="flex items-center flex-shrink-0 pl-4">
                                        <el-button type="primary" size="small" round @click="copyMagnet(res.magnet_link)" title="复制磁力链接">
                                            复制
                                        </el-button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div v-else class="border-2 border-dashed rounded-xl p-4 flex items-center justify-center opacity-60" style="border-color: var(--card-border); background-color: var(--tag-info-bg)">
                            <span class="font-mono mr-2" style="color: var(--text-secondary)">Episode {{ ep.num }}</span>
                            <span class="text-xs px-2 py-0.5 rounded" style="color: var(--text-secondary); background-color: var(--card-border)">暂无收录</span>
                        </div>

                    </template>
                </div>
                <div class="flex justify-center mt-8 pb-8">
                    <el-pagination
                        v-model:current-page="currentPage"
                        v-model:page-size="pageSize"
                        :page-sizes="[12, 24, 48, 100]"
                        layout="total, sizes, prev, pager, next, jumper"
                        :total="filteredTotal"
                        background
                        @current-change="scrollToTop"
                    />
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;
        const { Search, Refresh, Link, Key, Film, RefreshRight, Moon, Sunny, PriceTag } = ElementPlusIconsVue;
        const { ElMessage, ElNotification } = ElementPlus;

        const app = createApp({
            components: {
                Search, Refresh, Link, Key, Film, RefreshRight, Moon, Sunny, PriceTag
            },
            setup() {
                // 主题相关
                const isDark = ref(false);
                const toggleTheme = () => {
                    isDark.value = !isDark.value;
                    updateTheme();
                };
                const updateTheme = () => {
                    const html = document.documentElement;
                    if (isDark.value) {
                        html.setAttribute('data-theme', 'dark');
                        html.classList.add('dark'); // for Tailwind
                        localStorage.setItem('theme', 'dark');
                    } else {
                        html.setAttribute('data-theme', 'light');
                        html.classList.remove('dark'); // for Tailwind
                        localStorage.setItem('theme', 'light');
                    }
                };

                // 初始化主题
                onMounted(() => {
                    const savedTheme = localStorage.getItem('theme');
                    if (savedTheme) {
                        isDark.value = savedTheme === 'dark';
                    } else {
                        // 如果没有保存过，检测系统偏好
                        isDark.value = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    }
                    updateTheme();
                    
                    // 读取本地存储配置
                    const savedConfig = localStorage.getItem('project4869_emby_config');
                    if (savedConfig) embyConfig.value = JSON.parse(savedConfig);

                    // 设置 Element Plus 语言为中文
                    app.use(ElementPlus, { locale: ElementPlusLocaleZhCn });
                    fetchData();
                    fetchLogs(); // 初始加载日志
                    setInterval(fetchLogs, 5000); // 每5秒自动刷新日志
                });


                const magnets = ref([]);
                const groupedData = ref({});
                const maxEpisode = ref(0);
                const cronExpression = ref("0 */1 * * *");
                const rssEnabled = ref(false);
                const loadingCron = ref(false);
                const scraping = ref(false);
                const showLogs = ref(false);
                const logContent = ref("正在加载日志...");
                const filterType = ref("all");
                const searchQuery = ref(""); // 新增搜索变量
                const isEmbyMode = ref(false);
                const embyMissingList = ref([]);
                const embyTotalCount = ref(0);
                const lastSyncTime = ref("");

                // Emby 配置
                const embyConfig = ref({ host: '', apiKey: '', tmdbId: '30983' });
                const syncing = ref(false);

                // 分页状态
                const currentPage = ref(1);
                const pageSize = ref(24);

                const syncEmby = async () => {
                    if (!embyConfig.value.host || !embyConfig.value.apiKey) {
                        ElMessage.warning('请先填写 Host 和 API Key');
                        return;
                    }
                    
                    syncing.value = true;
                    // 保存配置到浏览器
                    localStorage.setItem('project4869_emby_config', JSON.stringify(embyConfig.value));
                    
                    try {
                        const res = await fetch('/api/emby/missing', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                host: embyConfig.value.host,
                                api_key: embyConfig.value.apiKey,
                                tmdb_id: embyConfig.value.tmdbId,
                                max_episode: maxEpisode.value
                            })
                        });
                        const json = await res.json();
                        
                        if (json.error) {
                            ElMessage.error(json.error);
                        } else {
                            embyMissingList.value = json.missing_episodes;
                            embyTotalCount.value = json.total_count || 0;
                            lastSyncTime.value = new Date().toLocaleTimeString();
                            
                            if (json.missing_episodes.length > 0) {
                                ElMessage.success(`同步成功，发现 ${json.missing_episodes.length} 集缺失`);
                                isEmbyMode.value = true; // 自动开启筛选
                            } else {
                                ElMessage.success('同步成功，您的媒体库是完整的！');
                                isEmbyMode.value = false;
                            }
                        }
                    } catch (e) {
                        ElMessage.error('网络请求失败');
                    } finally {
                        syncing.value = false;
                    }
                };

                const cleanTitle = (raw, epNum) => {
                    if (!raw) return "";
                    let title = raw;
                    const removePatterns = [
                        /\[银色子弹字幕组\]/g, /\[银色子弹\]/g, /\[SilverBullet\]/g,
                        /\[名侦探柯南\]/g, /\[名探偵コナン\]/g, /\[Detective Conan\]/g, /\[Conan\]/g,
                        /\[SBSUB\]/g
                    ];
                    removePatterns.forEach(p => title = title.replace(p, ''));
                    if (epNum) {
                        const epPatterns = [
                            new RegExp(`\\[${epNum}\\]`, 'g'),
                            new RegExp(`第${epNum}(集|话)`, 'g'),
                            new RegExp(`\\s${epNum}\\s`, 'g')
                        ];
                        epPatterns.forEach(p => title = title.replace(p, ''));
                    }
                    const techPatterns = [
                        /\[1080[Pp]\]/gi, /\[720[Pp]\]/gi, /\[4[Kk]\]/gi,
                        /\[WEBRIP\]/gi, /\[BDRIP\]/gi, /\[HDTV\]/gi,
                        /\[MP4\]/gi, /\[MKV\]/gi,
                        /\[简日双语\]/g, /\[简日\]/g, /\[繁日\]/g, /\[CHS_JP\]/g
                    ];
                    techPatterns.forEach(p => title = title.replace(p, ''));
                    title = title.replace(/\[\s*\]/g, '').replace(/【\s*】/g, '').replace(/\(\s*\)/g, '').trim();
                    if (/^[-.]+$/.test(title)) return "";
                    return title;
                };

                const fetchData = async () => {
                    try {
                        const res = await fetch('/api/magnets');
                        const json = await res.json();
                        magnets.value = json.data;
                        maxEpisode.value = json.max_episode || 0;
                        groupedData.value = json.grouped_by_episode;
                    } catch (e) {
                        ElMessage.error('无法连接到服务器');
                    }
                };

                const filteredEpisodes = computed(() => {
                    const list = [];
                    const start = maxEpisode.value > 0 ? maxEpisode.value : 1;
                    
                    // 预处理搜索关键字
                    let keywords = [];
                    if (searchQuery.value) {
                        keywords = searchQuery.value.toLowerCase().split(/\s+/).filter(k => k);
                    }

                    for (let i = start; i >= 1; i--) {
                        const data = groupedData.value[i] || [];
                        
                        // 1. Emby 模式筛选
                        if (isEmbyMode.value && lastSyncTime.value && !embyMissingList.value.includes(i)) continue;
                        
                        // 2. 搜索关键字筛选
                        if (keywords.length > 0) {
                            // 构建可搜索文本：集数 + 纯标题 + 所有文件名
                            // 注意：cleanTitle 可能依赖 data[0]，如果 data 为空需要处理
                            const epTitle = data.length > 0 ? (data[0].episode_title || cleanTitle(data[0].raw_title, i)) : "";
                            const fileNames = data.map(d => d.raw_title).join(" ");
                            const searchableText = `${i} ${epTitle} ${fileNames}`.toLowerCase();
                            
                            // 必须包含所有关键字
                            const match = keywords.every(kw => searchableText.includes(kw));
                            if (!match) continue;
                        }

                        // 3. 原有的筛选逻辑 (虽无 UI 触发，保留逻辑)
                        const exists = data.length > 0;
                        if (filterType.value === 'existing' && !exists) continue;
                        if (filterType.value === 'missing' && exists) continue;

                        list.push({ num: i, data: data });
                    }
                    return list;
                });

                const filteredTotal = computed(() => filteredEpisodes.value.length);

                const paginatedEpisodes = computed(() => {
                    const start = (currentPage.value - 1) * pageSize.value;
                    const end = start + pageSize.value;
                    return filteredEpisodes.value.slice(start, end);
                });

                const scrollToTop = () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const triggerScrape = async () => {
                    scraping.value = true;
                    try {
                        await fetch('/api/scrape/full', { method: 'POST' });
                        ElNotification({
                            title: '任务已提交',
                            message: '全量爬虫正在后台运行，请稍后刷新查看结果',
                            type: 'success',
                        });
                    } catch (e) {
                        ElMessage.error('请求失败');
                    } finally {
                        setTimeout(() => { scraping.value = false; }, 2000);
                    }
                };

                const updateCron = async (newVal) => {
                    // 只在试图打开开关时进行校验
                    if (newVal === true) {
                        if (!cronExpression.value || !cronExpression.value.trim()) {
                            ElMessage.warning('请先填写 Cron 表达式');
                            rssEnabled.value = false; // 回滚状态
                            return;
                        }
                    }

                    loadingCron.value = true;
                    try {
                        const res = await fetch('/api/rss/config', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ 
                                cron_expression: cronExpression.value,
                                enabled: rssEnabled.value
                            })
                        });
                        const json = await res.json();
                        if (res.ok) {
                            ElMessage.success(json.message);
                        } else {
                            ElMessage.error(json.error || '更新失败');
                            // 如果是开启失败，则回滚开关
                            if (rssEnabled.value) rssEnabled.value = false;
                        }
                    } catch (e) {
                        ElMessage.error('请求失败');
                        // 如果是开启失败，则回滚开关
                        if (rssEnabled.value) rssEnabled.value = false;
                    } finally {
                        loadingCron.value = false;
                    }
                };

                const clearDatabase = async () => {
                    try {
                        const res = await fetch('/api/database', { method: 'DELETE' });
                        if (res.ok) {
                            ElMessage.success('数据库已清空');
                            magnets.value = [];
                            maxEpisode.value = 0;
                            groupedData.value = {};
                        } else {
                            ElMessage.error('清空失败');
                        }
                    } catch (e) {
                        ElMessage.error('请求失败');
                    }
                };

                const fetchLogs = async () => {
                    try {
                        const res = await fetch('/api/system/logs');
                        const json = await res.json();
                        logContent.value = json.logs.reverse().join('');
                    } catch (e) {
                        logContent.value = "无法获取日志";
                    }
                };

                const copyMagnet = (link) => {
                    navigator.clipboard.writeText(link).then(() => {
                        ElMessage({ message: '磁力链接已复制', type: 'success', duration: 1500 });
                    });
                };

                return {
                    isDark,
                    toggleTheme,
                    Sunny: ElementPlusIconsVue.Sunny,
                    Moon: ElementPlusIconsVue.Moon,
                    Monitor: ElementPlusIconsVue.Monitor,
                    Refresh: ElementPlusIconsVue.Refresh,
                    Document: ElementPlusIconsVue.Document,
                    Paperclip: ElementPlusIconsVue.Paperclip,
                    Link: ElementPlusIconsVue.Link,
                    Key: ElementPlusIconsVue.Key,
                    Film: ElementPlusIconsVue.Film,
                    PriceTag: ElementPlusIconsVue.PriceTag,
                    RefreshRight: ElementPlusIconsVue.RefreshRight,
                    magnets,
                    maxEpisode,
                    cronExpression,
                    rssEnabled,
                    loadingCron,
                    updateCron,
                    clearDatabase,
                    scraping,
                    triggerScrape,
                    showLogs,
                    logContent,
                    fetchLogs,
                    filterType,
                    isEmbyMode,
                    embyMissingList,
                    embyTotalCount,
                    embyConfig,
                    syncEmby,
                    syncing,
                    lastSyncTime,
                    cleanTitle,
                    copyMagnet,
                    paginatedEpisodes,
                    filteredTotal,
                    currentPage,
                    pageSize,
                    scrollToTop,
                    searchQuery // 导出 searchQuery
                };
            }
        });

        app.use(ElementPlus);
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.mount('#app');
    </script>
</body>
</html>